<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- CONFIGURATION PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tricot Cats">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="tricot-removebg-preview.png">
    <link rel="apple-touch-icon" href="tricot-removebg-preview.png">
    
    <title>Tricot Design</title>
    <style>
        /* --- MODERN DESIGN SYSTEM --- */
        :root { 
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #bb86fc; 
            --primary-glow: rgba(187, 134, 252, 0.4);
            --secondary: #03dac6; 
            --alert: #cf6679; 
            --text: #ffffff; 
            --text-dim: rgba(255, 255, 255, 0.6);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            
            /* COULEURS DES BARRES */
            --bar-fill: linear-gradient(90deg, #8E2DE2, #4A00E0); /* Violet profond */
            
            /* LE VRAI DOR√â (Fini le jaune pisse !) */
            --bar-action: linear-gradient(135deg, #d4af37 0%, #edc967 50%, #d4af37 100%); /* Or M√©tallique */
            --gold-glow: rgba(212, 175, 55, 0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background: var(--bg-gradient); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            height: 100dvh; 
            display: flex; flex-direction: column; 
            overflow: hidden; user-select: none; 
        }

        /* --- ANIMATIONS --- */
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* --- STRUCTURE --- */
        .screen { 
            display: none; height: 100%; flex-direction: column; padding: 20px; 
            padding-top: calc(env(safe-area-inset-top) + 20px);
            padding-bottom: calc(env(safe-area-inset-bottom) + 30px);
            animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .screen.active { display: flex; }

        /* --- TYPOGRAPHIE & UI --- */
        h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        h1 { font-size: 2rem; background: linear-gradient(to right, #fff, #bb86fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        button { 
            border: none; border-radius: var(--radius-md); font-weight: 600; font-size: 1rem; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            transition: all 0.2s ease; 
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:active { transform: scale(0.96); }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), #9a67ea); 
            color: #000; padding: 16px; 
            box-shadow: 0 8px 20px var(--primary-glow);
        }
        .btn-secondary { 
            background: var(--glass); border: 1px solid var(--glass-border); color: var(--primary); padding: 12px 16px; 
        }
        /* Nouveau bouton neutre pour la correction */
        .btn-neutral { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-dim); padding: 12px; 
        }
        .btn-danger { /* Gard√© pour la suppression de projet uniquement */
            background: rgba(207, 102, 121, 0.15); border: 1px solid rgba(207, 102, 121, 0.3); color: var(--alert); padding: 12px; 
        }
        
        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 20px; margin-bottom: 10px; 
        }

        /* --- CARDS (GLASSMORPHISM) --- */
        .scroll-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding: 5px; min-height: 0; }
        
        .folder-card, .part-card { 
            background: var(--glass); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 20px; border-radius: var(--radius-lg); 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid var(--glass-border);
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .folder-card:active, .part-card:active { background: rgba(255,255,255,0.12); transform: scale(0.98); }
        
        .folder-info h3 { font-size: 1.2rem; margin-bottom: 4px; color: white; }
        .folder-info span { color: var(--text-dim); font-size: 0.9rem; font-weight: 500; }
        
        /* --- COMPTEUR MODERNE --- */
        #main-click-zone { 
            flex: 2; 
            background: rgba(255,255,255,0.03); 
            border-radius: 32px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 1px solid var(--glass-border); 
            margin-bottom: 20px; position: relative; overflow: hidden; 
            box-shadow: inset 0 0 40px rgba(0,0,0,0.2);
            transition: all 0.1s;
        }
        #main-click-zone:active { transform: scale(0.98); background: rgba(255,255,255,0.06); border-color: var(--primary); }
        
        #counter-display { 
            font-size: 8rem; font-weight: 800; line-height: 1; 
            background: linear-gradient(to bottom, #fff, #ccc); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3));
        }
        #counter-part-name { font-size: 1.5rem; margin-top: 10px; opacity: 0.9; }
        #counter-folder-name { text-transform: uppercase; letter-spacing: 2px; font-size: 0.75rem; opacity: 0.5; margin-bottom: 5px; }

        /* --- SATELLITES (REGLES) --- */
        #satellites-area { 
            flex: 1.5; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; 
            padding: 5px; min-height: 0; 
        }
        .satellite-row { 
            background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 15px; 
            position: relative; overflow: hidden; display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        /* CHANGEMENT : Barres violettes douces par d√©faut */
        .progress-bar-bg { 
            position: absolute; top: 0; bottom: 0; left: 0; 
            background: var(--bar-fill); 
            opacity: 0.4; z-index: 0; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        /* CHANGEMENT : Barres dor√©es effet luxe pour l'alerte */
        .progress-bar-bg.alert { 
            background: var(--bar-action); 
            opacity: 0.9; 
            box-shadow: 0 0 20px var(--gold-glow);
        }
        .satellite-content { position: relative; z-index: 1; display: flex; width: 100%; justify-content: space-between; font-weight: 600; font-size: 0.95rem; }

        /* --- LOGO & INDICATEURS --- */
        .app-logo { 
            display: block; margin: 0 auto 20px auto; max-width: 160px; height: auto; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); 
            animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #sync-status { 
            position: fixed; top: max(15px, env(safe-area-inset-top) + 15px); right: 20px; 
            width: 12px; height: 12px; border-radius: 50%; background: #555; 
            border: 2px solid rgba(255,255,255,0.2); 
            z-index: 9999; transition: all 0.3s; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        /* Indicateur de statut avec le m√™me dor√© */
        #sync-status.syncing { background: #D4AF37; box-shadow: 0 0 10px #D4AF37; border-color: #fff; animation: pulse 1s infinite; }
        #sync-status.synced { background: #27ae60; box-shadow: 0 0 10px #27ae60; border-color: #fff; }
        #sync-status.error { background: #eb5757; border-color: white; }

        /* --- MODALS MODERNES --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 10000; padding: 20px; 
            animation: fadeIn 0.2s ease;
        }
        .modal-box { 
            background: #1e1e1e; width: 100%; max-width: 380px; 
            border-radius: var(--radius-lg); padding: 30px; 
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: translateY(20px); animation: slideIn 0.3s forwards;
        }
        input, select { 
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); 
            color: white; padding: 15px; border-radius: var(--radius-sm); font-size: 1.1rem; margin: 15px 0 25px 0; 
            transition: border 0.2s;
        }
        input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }

        /* --- NOTIFICATIONS & ALERTS --- */
        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px);
            color: white; padding: 12px 24px; border-radius: 50px; 
            font-weight: 600; font-size: 0.9rem; 
            z-index: 3000; opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none; border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        #flash-alert { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            /* UTILISATION DU VIOLET SOMBRE DEMANDE: #4a006a */
            background: linear-gradient(135deg, #4a006a, #2a0040); 
            backdrop-filter: blur(5px);
            color: white; 
            display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 2000; text-align: center; padding: 30px; 
        }
        #flash-message { font-size: 3rem; font-weight: 800; margin-bottom: 40px; line-height: 1.2; }
        
        /* Style du bouton dans l'alerte pour qu'il ressorte sur le violet fonc√© */
        #flash-btn { 
            background: rgba(255,255,255,0.2); /* Verre givr√© blanc */
            color: white; 
            border: 1px solid rgba(255,255,255,0.4);
            padding: 20px 50px; border-radius: 40px; font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
            height: 80px; margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- INDICATEUR DE SYNCHRO -->
    <div id="sync-status" title="√âtat de la synchro"></div>

    <!-- ECRAN 1: ACCUEIL -->
    <div id="screen-home" class="screen active">
        <img src="tricot-removebg-preview.png" alt="Logo Chats Tricot" class="app-logo">
        
        <div class="header-bar">
            <h1>Mes Projets</h1>
            <button class="btn-primary" onclick="openModal('modal-create-folder')" style="width: 45px; height: 45px; padding: 0; font-size: 1.5rem; border-radius: 50%; box-shadow: 0 5px 15px var(--primary-glow);">+</button>
        </div>
        
        <div id="loading-msg" style="margin-top:20px;">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
            <div class="skeleton"></div>
        </div>
        
        <div id="error-box" style="display:none; background: rgba(207, 102, 121, 0.1); border: 1px solid var(--alert); padding: 20px; border-radius: var(--radius-md); text-align: center;">
            <strong id="error-title" style="color:var(--alert); font-size: 1.1rem;">Erreur</strong><br>
            <span id="error-desc" style="color:white; font-size: 0.9rem; display:block; margin: 10px 0;">Description</span>
            <button class="btn-secondary" onclick="fetchData()" style="width:100%; margin-top:10px;">R√©essayer</button>
        </div>
        
        <div id="folders-list" class="scroll-area"></div>
    </div>

    <!-- ECRAN 2: DOSSIER -->
    <div id="screen-folder" class="screen">
        <div class="header-bar">
            <button class="btn-secondary" onclick="goHome()" style="border-radius: 50%; width: 40px; height: 40px; padding:0;">‚Üê</button>
            <h2 id="folder-title-display" style="font-size: 1.3rem; opacity: 0.9;">Titre</h2>
            <button class="btn-primary" onclick="openModal('modal-create-part')" style="border-radius: 50%; width: 40px; height: 40px; padding:0;">+</button>
        </div>
        <div id="parts-list" class="scroll-area"></div>
    </div>

    <!-- ECRAN 3: COMPTEUR -->
    <div id="screen-counter" class="screen">
        <div class="header-bar">
            <button class="btn-secondary" onclick="goBackToFolder()" style="border-radius: 50%; width: 40px; height: 40px; padding:0;">‚Üê</button>
            <div style="text-align:center">
                <div id="counter-folder-name">PROJET</div>
                <div id="counter-part-name" style="font-weight:700;">Morceau</div>
            </div>
            <button class="btn-secondary" onclick="openModal('modal-rule')" style="border-radius: 50%; width: 40px; height: 40px; padding:0;">‚öôÔ∏è</button>
        </div>
        
        <div id="main-click-zone" onclick="increment()">
            <div id="counter-display">0</div>
            <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 3px; opacity: 0.5; margin-top: 10px;">Rangs</div>
        </div>
        
        <div id="satellites-area"></div>
        
        <div style="display: flex; gap: 15px; margin-top: 20px; flex-shrink: 0;">
            <!-- Changement ici : Bouton Neutre (Gomme) au lieu de Danger -->
            <button class="btn-neutral" style="flex:1" onclick="decrement()">-1 (Correction)</button>
            <button class="btn-secondary" style="flex:1" onclick="openDuplicateModal()">üëØ Sym√©trie</button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-create-folder" class="modal-overlay"><div class="modal-box"><h3 style="margin-bottom:5px">Nouveau Projet</h3><p style="opacity:0.6; font-size:0.9rem; margin-bottom:20px">Ex: Pull Irlandais, Echarpe...</p><input type="text" id="input-folder-name" placeholder="Nom du projet..."><div style="display:flex; gap:10px;"><button class="btn-secondary" style="flex:1" onclick="closeModals()">Annuler</button><button class="btn-primary" style="flex:1" onclick="createFolder()">Cr√©er</button></div></div></div>
    
    <div id="modal-create-part" class="modal-overlay"><div class="modal-box"><h3>Ajouter un morceau</h3><input type="text" id="input-part-name" placeholder="Ex: Manche Gauche"><div style="display:flex; gap:10px;"><button class="btn-secondary" style="flex:1" onclick="closeModals()">Annuler</button><button class="btn-primary" style="flex:1" onclick="createPart()">Ajouter</button></div></div></div>
    
    <div id="modal-duplicate-part" class="modal-overlay"><div class="modal-box"><h3>Sym√©trie</h3><p style="color:var(--text-dim); font-size:0.9rem; margin: 10px 0 20px 0; line-height:1.5">Cr√©e une copie parfaite des r√®gles pour l'autre c√¥t√©, avec le compteur √† z√©ro.</p><input type="text" id="input-duplicate-name"><div style="display:flex; gap:10px;"><button class="btn-secondary" style="flex:1" onclick="closeModals()">Annuler</button><button class="btn-primary" style="flex:1" onclick="executeDuplication()">Valider</button></div></div></div>
    
    <div id="modal-rule" class="modal-overlay"><div class="modal-box"><h3>Ajouter R√®gle</h3><select id="input-rule-type"><option value="modulo">R√©p√©tition (Tous les X rangs)</option><option value="target">Objectif (Au rang X)</option></select><input type="number" id="input-rule-val" placeholder="Nombre (ex: 6)"><input type="text" id="input-rule-name" placeholder="Nom (ex: Torsade)"><button class="btn-primary" style="width:100%" onclick="addRule()">Ajouter la r√®gle</button><div style="border-top:1px solid var(--glass-border); margin-top:20px; padding-top:15px; max-height:150px; overflow-y:auto;" id="rules-list-preview"></div><button class="btn-secondary" style="width:100%; margin-top:10px" onclick="closeModals()">Fermer</button></div></div>
    
    <div id="flash-alert" onclick="this.style.display='none'"><div id="flash-message">ALERTE</div><button id="flash-btn">C'est not√© !</button></div>
    
    <div id="toast">Info</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwO5NXC4tNO2oHi-q_zawF9kNu1b1TOym2jU4ifp6KK9T0rnR2AW2ivk0BR6KGVKSoT/exec";

    let data = []; let activeFolderId = null; let activePartId = null; let saveTimeout = null;

    function setSyncStatus(status) { document.getElementById('sync-status').className = status; }

    // --- ENGINE ROBUSTE ---
    async function fetchData() {
        setSyncStatus('syncing');
        const loadMsg = document.getElementById('loading-msg');
        const errBox = document.getElementById('error-box');
        
        loadMsg.style.display = 'block';
        errBox.style.display = 'none';

        try {
            const urlWithCacheBust = API_URL + "?t=" + new Date().getTime();
            const res = await fetch(urlWithCacheBust);
            if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
            const text = await res.text();
            try {
                const json = JSON.parse(text);
                data = json; 
                setSyncStatus('synced');
                loadMsg.style.display = 'none';
                renderFolders();
            } catch (jsonError) {
                console.error("Re√ßu du HTML au lieu de JSON:", text.substring(0, 100));
                throw new Error("PERMISSION_DENIED");
            }
        } catch (e) {
            console.error(e); setSyncStatus('error');
            loadMsg.style.display = 'none'; errBox.style.display = 'block';
            if (e.message === "PERMISSION_DENIED" || e.message.includes("Unexpected token")) {
                document.getElementById('error-title').textContent = "üîí Acc√®s Refus√©";
                document.getElementById('error-desc').innerHTML = "Le script Google doit √™tre accessible √† <b>'Tout le monde'</b>.";
            } else {
                document.getElementById('error-title').textContent = "üì° Erreur Connexion";
                document.getElementById('error-desc').textContent = "V√©rifiez votre internet.";
            }
        }
    }

    function scheduleSave() {
        setSyncStatus('syncing');
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'}, body: JSON.stringify(data) });
                setSyncStatus('synced');
            } catch (e) { setSyncStatus('error'); }
        }, 1500);
    }

    // --- NAVIGATION ---
    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='modal-rule') renderRulesList(); }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
    function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    function vibrate(p) { if(navigator.vibrate) navigator.vibrate(p); }

    // --- LOGIQUE ---
    function renderFolders() {
        const list = document.getElementById('folders-list'); list.innerHTML = '';
        if(data.length === 0) list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:40px">‚ú® Aucun projet.<br>Commencez par en cr√©er un !</div>';
        data.forEach(f => {
            const div = document.createElement('div'); div.className = 'folder-card';
            div.innerHTML = `<div class="folder-info"><h3>${f.name}</h3><span>${f.parts.length} morceaux</span></div><div style="opacity:0.5; font-size:1.2rem">‚Ä∫</div>`;
            div.onclick = () => openFolder(f.id); list.appendChild(div);
        });
    }
    function createFolder() {
        const name = document.getElementById('input-folder-name').value.trim(); if(!name) return;
        data.push({ id: "f_"+Date.now(), name: name, parts: [] });
        scheduleSave(); renderFolders(); closeModals(); document.getElementById('input-folder-name').value='';
    }
    function openFolder(id) {
        activeFolderId = id; let folder = data.find(f => f.id === id); if(!folder) return switchScreen('screen-home');
        document.getElementById('folder-title-display').textContent = folder.name; renderParts(); switchScreen('screen-folder');
    }
    function goHome() { switchScreen('screen-home'); renderFolders(); }
    function renderParts() {
        const folder = data.find(f => f.id === activeFolderId); const list = document.getElementById('parts-list'); list.innerHTML = '';
        if(folder.parts.length===0) list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:40px">Ce dossier est vide. üß∂</div>';
        folder.parts.forEach(p => {
            const div = document.createElement('div'); div.className = 'part-card';
            div.innerHTML = `<div><h4>${p.name}</h4><span style="font-size:0.8rem; opacity:0.7">${p.rules.length} r√®gles</span></div><div style="display:flex; align-items:center; gap:15px"><span class="part-preview">${p.rows}</span><button class="btn-danger btn-circle" style="width:35px; height:35px" onclick="deletePart(event, '${p.id}')">üóë</button></div>`;
            div.onclick = (e) => { if(e.target.tagName!=='BUTTON') openPart(p.id); }; list.appendChild(div);
        });
    }
    function createPart() {
        const name = document.getElementById('input-part-name').value.trim(); if(!name) return;
        const folder = data.find(f => f.id === activeFolderId);
        folder.parts.push({ id: "p_"+Date.now(), name: name, rows: 0, rules: [] });
        scheduleSave(); renderParts(); closeModals(); document.getElementById('input-part-name').value='';
    }
    function deletePart(e, pid) {
        e.stopPropagation(); if(!confirm("Supprimer ce compteur ?")) return;
        const folder = data.find(f => f.id === activeFolderId); folder.parts = folder.parts.filter(p => p.id !== pid);
        scheduleSave(); renderParts();
    }
    function openPart(pid) { activePartId = pid; renderCounter(); switchScreen('screen-counter'); }
    function goBackToFolder() { openFolder(activeFolderId); }
    function renderCounter() {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        document.getElementById('counter-folder-name').textContent = folder.name;
        document.getElementById('counter-part-name').textContent = part.name;
        document.getElementById('counter-display').textContent = part.rows;
        const area = document.getElementById('satellites-area'); area.innerHTML = '';
        part.rules.forEach(r => {
            let pct=0, txt="", isAlert=false;
            if(r.type==='modulo') {
                const mod = part.rows % r.val; pct = (mod===0 && part.rows>0) ? 100 : (mod/r.val*100); if(part.rows===0) pct=0;
                txt = (mod===0 && part.rows>0) ? "ACTION !" : `${mod}/${r.val}`; if(mod===0 && part.rows>0) isAlert=true;
            } else {
                pct = Math.min(100, (part.rows/r.val*100)); const rem = r.val - part.rows;
                txt = rem<=0 ? "FINI" : `Reste: ${rem}`; if(rem<=0) isAlert=true;
            }
            const div = document.createElement('div'); div.className = 'satellite-row';
            div.innerHTML = `<div class="progress-bar-bg ${isAlert?'alert':''}" style="width:${pct}%"></div><div class="satellite-content"><span>${r.name}</span><span>${txt}</span></div>`;
            area.appendChild(div);
        });
    }
    function increment() {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        part.rows++; renderCounter(); scheduleSave();
        let alerts = []; part.rules.forEach(r => {
            if(r.type==='modulo' && part.rows>0 && part.rows%r.val===0) alerts.push(r.name);
            if(r.type==='target' && part.rows===r.val) alerts.push("Fin: "+r.name);
        });
        if(alerts.length>0) {
            document.getElementById('flash-message').innerHTML = alerts.join('<br>+<br>');
            document.getElementById('flash-alert').style.display='flex'; vibrate([300,100,300]);
        } else vibrate(50);
    }
    function decrement() {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        if(part.rows>0) { part.rows--; renderCounter(); scheduleSave(); }
    }
    function openDuplicateModal() {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        document.getElementById('input-duplicate-name').value = part.name + " (Suite)"; openModal('modal-duplicate-part');
    }
    function executeDuplication() {
        const name = document.getElementById('input-duplicate-name').value.trim(); if(!name) return;
        const folder = data.find(f => f.id === activeFolderId); const oldPart = folder.parts.find(p => p.id === activePartId);
        folder.parts.push({ id: "p_"+Date.now(), name: name, rows: 0, rules: JSON.parse(JSON.stringify(oldPart.rules)) });
        scheduleSave(); showToast("Sym√©trie cr√©√©e !"); closeModals(); goBackToFolder();
    }
    function renderRulesList() {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        const list = document.getElementById('rules-list-preview'); list.innerHTML = '';
        part.rules.forEach((r, idx) => {
            const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='5px 0';
            d.innerHTML = `<span>${r.name} (${r.val})</span><span style="color:var(--alert); cursor:pointer" onclick="removeRule(${idx})">‚úï</span>`; list.appendChild(d);
        });
    }
    function addRule() {
        const type = document.getElementById('input-rule-type').value; const val = parseInt(document.getElementById('input-rule-val').value);
        const name = document.getElementById('input-rule-name').value; if(!val||!name) return;
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        part.rules.push({type,val,name}); renderRulesList(); renderCounter(); scheduleSave();
        document.getElementById('input-rule-val').value='';
    }
    function removeRule(idx) {
        const folder = data.find(f => f.id === activeFolderId); const part = folder.parts.find(p => p.id === activePartId);
        part.rules.splice(idx,1); renderRulesList(); renderCounter(); scheduleSave();
    }

    fetchData(); 
</script>
</body>
</html>
